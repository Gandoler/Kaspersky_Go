# Для лучше репрезентативности, перейдите пожалуйста в мой [gitHub](https://github.com/Gandoler/Kaspersky_Go) репозиторий
# TASK 1 Kaspersky Container Security — Очередь фоновой обработки задач

Внутренний сервис для приёма задач через HTTP и их фоновой обработки пулом воркеров с повторными попытками и экспоненциальным бэкоффом. на go 1.24.7

> в этом проекте я пытался использовать архитектурный подход, для последующего простого тестирования, старался все прокидывать через интерфейсы, а главное использовал паттерн Builder для более удобной сборки приложения и внедрения зависимостей

## Запуск

### быстрый старт с докером

```bash
cd .../Kaspersky_Go\TASK_1\Dockerfile # путь относительно корня проекта

docker build -t Task1 .
docker run --rm -it -p 8080:8080 --name Task1Cont Task1

```


### базовый

Переменные окружения:
- `WORKERS` — количество воркеров; по заданию значение по умолчанию 4
- `QUEUE_SIZE` — размер буфера очереди; по заданию значение по умолчанию 64

```bash
export WORKERS=4
export QUEUE_SIZE=64
go run ./...
```


## Архитектура (слои)
- ###########################################################################################################################################################
- `APILevel/HTTPServer`: HTTP-сервер и хендлеры (`/healthz`, `/enqueue`).
- `APILevel/Adapters`: внутренняя реализация адаптеров — буферизированная очередь и хранилище состояний в памяти.
- `APILevel/Builder`: сборка `App` из компонентов и управление запуском/остановкой (graceful shutdown).
- ###########################################################################################################################################################
- `ServiceLevel/UseCases/WokerPool`: пул воркеров, забирающий задания из очереди, обновляющий статусы и вызывающий процессор.
- `ServiceLevel/UseCases/Processors`: процессор задач с имитацией работы, отказов, бэкоффа и ретраев.
- ###########################################################################################################################################################
- `ModeLevel/Structures`: типы и состояния задач.
- ###########################################################################################################################################################



## HTTP API

- `GET /healthz`
  - Ответ: `200 OK`, тело — `OK`

- `POST /enqueue`
  - Тело JSON:
    ```json
    {"id":"<string>","payload":"<string>","max_retries":<int>}
    ```
  - Поведение: задача кладётся в буферизированную очередь, в `state` устанавливается статус `queued`
  - Ответ: `202 Accepted`, тело: `{"status":"queued"}`

## Состояния задач

Определены в `ModeLevel/Structures/Structs.go`:
- `queued`, `running`, `done`, `failed`

## Обработка задач

- Пул воркеров (`WokerPool`): число воркеров настраивается через `WORKERS`.
- Процессор (`RetryProcessor`):
  - имитирует выполнение 100–150 мс в текущей реализации
  - 20% вероятности «падения»
  - экспоненциальный бэкофф c джиттером между ретраями
  - до `max_retries` повторов

## Завершение (graceful shutdown)

`App.Start` перехватывает `SIGINT/SIGTERM`, останавливает HTTP-сервер через `Shutdown(ctx)` и закрывает очередь; воркеры завершаются после обработки текущей задачи (или выхода из канала после `Close()`).

## Тесты

См. `TESTS/README.md`.

Запуск:
```bash
go test ./...
```
